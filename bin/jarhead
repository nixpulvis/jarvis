#!/usr/bin/env ruby

require "thor"
require "highline"

class Jarhead < Thor

  desc "new [PROJECT_NAME]", "create a new Java project"
  def new( name )
    if File.directory? name
      say "Folder #{name} already exists."
      exit
    end
    Dir.mkdir name
    Dir.mkdir File.join(name, 'src')
    Dir.mkdir File.join(name, 'test')
  end

  desc "test", "recursively run all the test classes in ./test"
  def test
    ensure_bin
    compile = system "javac -d bin src/*.java test/*.java"
    if compile
      Dir.foreach('test') do |f|
        next if f == '.' or f == '..'
        say ".............................."
        say "Testing #{File.basename(f, '.*')}"
        say ".............................."
        system "java -cp bin #{File.basename(f, '.*')}"
      end
    end
  end

  desc "exec [CLASS]", "compile src and run the given class"
  def exec( klass )
    ensure_bin
    say ".............................."
    say "Running #{klass}"
    say ".............................."
    compile = system "javac -d bin src/*.java"
    system "java -cp bin #{klass}" if compile
  end

  desc "ssh", "run stuff."
  def ssh
    require "net/ssh"
    require 'net/sftp'

    # Ash for username and password.
    username = ask "Enter your CCS username:"
    password = get_password

    # Test username/password
    Net::SSH.start('blackwidow.ccs.neu.edu', username, password: password)

    # Gather files that we might want to submit.
    files = []
    Dir.foreach('src') do |f|
      next if f == "." or f == ".."
      files << File.join("src", f)
    end
    Dir.foreach('test') do |f|
      next if f == "." or f == ".."
      files << File.join("test", f)
    end

    # Prompt for user selection
    files.each_with_index do |f, i|
      say "#{i}.  #{f}"
    end
    choice = ask("What file?").to_i
    basename = File.basename files[choice]

    # transfer the file to the linuxbox desktop
    Net::SFTP.start('blackwidow.ccs.neu.edu', username, password: password) do |sftp|
      sftp.upload!("#{files[choice]}", "/home/#{username}/Desktop/#{basename}")
    end

    # run OOD's submit script
    Net::SSH.start('blackwidow.ccs.neu.edu', username, password: password) do |ssh|
      # capture only stdout matching a particular pattern
      stdout = ""
      assign_num = ask "What assignment number is this?"
      ssh.exec!("/course/cs3500wc/submit #{username} #{assign_num} /home/#{username}/Desktop/#{basename}") do |channel, stream, data|
        stdout << data if stream == :stdout
      end
      puts stdout
    end
  end


  no_tasks do

    def ensure_bin
      Dir.mkdir "bin" unless File.directory? 'bin'
    end

    def get_password( prompt="Enter CCS password: " )
      ask(prompt) { |q| q.echo = false }
    end

  end

end

Jarhead.start